name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint-and-build:
    name: Lint and Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint
        continue-on-error: true

      - name: Build shared packages
        run: |
          cd packages/shared-kernel && npm run build
          cd ../shared-config && npm run build

      - name: Build services
        run: |
          cd services/auth-service && npm run build || echo "Build skipped"
          cd ../catalog-service && npm run build || echo "Build skipped"
          cd ../cart-service && npm run build || echo "Build skipped"
          cd ../order-service && npm run build || echo "Build skipped"
          cd ../payment-service && npm run build || echo "Build skipped"
          cd ../notification-service && npm run build || echo "Build skipped"
        continue-on-error: true

      - name: Build frontend
        run: cd apps/web && npm run build
        env:
          AUTH_SERVICE_URL: ${{ secrets.AUTH_SERVICE_URL || 'http://localhost:3001' }}
          CATALOG_SERVICE_URL: ${{ secrets.CATALOG_SERVICE_URL || 'http://localhost:3002' }}
          CART_SERVICE_URL: ${{ secrets.CART_SERVICE_URL || 'http://localhost:3003' }}
          ORDER_SERVICE_URL: ${{ secrets.ORDER_SERVICE_URL || 'http://localhost:3004' }}
          PAYMENT_SERVICE_URL: ${{ secrets.PAYMENT_SERVICE_URL || 'http://localhost:3005' }}
          NOTIFICATION_SERVICE_URL: ${{ secrets.NOTIFICATION_SERVICE_URL || 'http://localhost:3006' }}

  type-check:
    name: Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check packages
        run: |
          cd packages/shared-kernel && npx tsc --noEmit
          cd ../shared-config && npx tsc --noEmit

      - name: Type check services
        run: |
          cd services/auth-service && npx tsc --noEmit || echo "Type check skipped"
          cd ../catalog-service && npx tsc --noEmit || echo "Type check skipped"
          cd ../cart-service && npx tsc --noEmit || echo "Type check skipped"
          cd ../order-service && npx tsc --noEmit || echo "Type check skipped"
          cd ../payment-service && npx tsc --noEmit || echo "Type check skipped"
          cd ../notification-service && npx tsc --noEmit || echo "Type check skipped"
        continue-on-error: true

      - name: Type check frontend
        run: cd apps/web && npx tsc --noEmit

